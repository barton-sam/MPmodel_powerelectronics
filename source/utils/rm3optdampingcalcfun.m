function [pto_damping,pto_stiffness] = rm3optdampingcalcfun(T_ref,option)
% 
% RM3 hydrodynamic parameters copied from WEC-Sim.
% Set option = "damping" for only damping.
% Set option = "PI" for damping and stiffness.

T = [
    314.1593
    157.0796
    104.7198
    78.5398
    62.8319
    52.3599
    44.8799
    39.2699
    34.9066
    31.4159
    28.5599
    26.1799
    24.1661
    22.4399
    20.9440
    19.6349
    18.4800
    17.4533
    16.5347
    15.7080
    14.9600
    14.2800
    13.6591
    13.0900
    12.5664
    12.0831
    11.6355
    11.2200
    10.8331
    10.4720
    10.1342
    9.8175
    9.5200
    9.2400
    8.9760
    8.7266
    8.4908
    8.2674
    8.0554
    7.8540
    7.6624
    7.4800
    7.3060
    7.1400
    6.9813
    6.8296
    6.6842
    6.5450
    6.4114
    6.2832
    6.1600
    6.0415
    5.9275
    5.8178
    5.7120
    5.6100
    5.5116
    5.4165
    5.3247
    5.2360
    5.1502
    5.0671
    4.9867
    4.9087
    4.8332
    4.7600
    4.6889
    4.6200
    4.5530
    4.4880
    4.4248
    4.3633
    4.3036
    4.2454
    4.1888
    4.1337
    4.0800
    4.0277
    3.9767
    3.9270
    3.8785
    3.8312
    3.7851
    3.7400
    3.6960
    3.6530
    3.6110
    3.5700
    3.5299
    3.4907
    3.4523
    3.4148
    3.3781
    3.3421
    3.3069
    3.2725
    3.2388
    3.2057
    3.1733
    3.1416
    3.1105
    3.0800
    3.0501
    3.0208
    2.9920
    2.9638
    2.9361
    2.9089
    2.8822
    2.8560
    2.8303
    2.8050
    2.7802
    2.7558
    2.7318
    2.7083
    2.6851
    2.6624
    2.6400
    2.6180
    2.5964
    2.5751
    2.5541
    2.5335
    2.5133
    2.4933
    2.4737
    2.4544
    2.4353
    2.4166
    2.3982
    2.3800
    2.3621
    2.3445
    2.3271
    2.3100
    2.2931
    2.2765
    2.2601
    2.2440
    2.2281
    2.2124
    2.1969
    2.1817
    2.1666
    2.1518
    2.1371
    2.1227
    2.1085
    2.0944
    2.0805
    2.0668
    2.0533
    2.0400
    2.0268
    2.0138
    2.0010
    1.9884
    1.9758
    1.9635
    1.9513
    1.9393
    1.9274
    1.9156
    1.9040
    1.8925
    1.8812
    1.8700
    1.8589
    1.8480
    1.8372
    1.8265
    1.8160
    1.8055
    1.7952
    1.7850
    1.7749
    1.7649
    1.7551
    1.7453
    1.7357
    1.7262
    1.7167
    1.7074
    1.6982
    1.6890
    1.6800
    1.6711
    1.6622
    1.6535
    1.6448
    1.6362
    1.6278
    1.6194
    1.6111
    1.6029
    1.5947
    1.5867
    1.5787
    1.5708
    1.5630
    1.5552
    1.5476
    1.5400
    1.5325
    1.5250
    1.5177
    1.5104
    1.5032
    1.4960
    1.4889
    1.4819
    1.4749
    1.4680
    1.4612
    1.4544
    1.4477
    1.4411
    1.4345
    1.4280
    1.4215
    1.4151
    1.4088
    1.4025
    1.3963
    1.3901
    1.3840
    1.3779
    1.3719
    1.3659
    1.3600
    1.3541
    1.3483
    1.3426
    1.3368
    1.3312
    1.3256
    1.3200
    1.3145
    1.3090
    1.3036
    1.2982
    1.2928
    1.2875
    1.2823
    1.2771
    1.2719
    1.2668
    1.2617
    1.2566
    1.2516
    1.2467
    1.2417
    1.2368
    1.2320
    1.2272
    1.2224
    1.2177
    1.2130
    1.2083
    ];

A_float_norm = 1000*[
    1.9883
    1.9958
    2.0057
    2.0169
    2.0286
    2.0404
    2.0518
    2.0623
    2.0715
    2.0790
    2.0847
    2.0882
    2.0894
    2.0880
    2.0840
    2.0773
    2.0677
    2.0554
    2.0403
    2.0225
    2.0021
    1.9794
    1.9545
    1.9276
    1.8990
    1.8690
    1.8377
    1.8055
    1.7727
    1.7395
    1.7062
    1.6729
    1.6398
    1.6072
    1.5751
    1.5437
    1.5131
    1.4833
    1.4544
    1.4265
    1.3995
    1.3735
    1.3484
    1.3244
    1.3013
    1.2791
    1.2580
    1.2377
    1.2184
    1.2000
    1.1825
    1.1658
    1.1501
    1.1351
    1.1210
    1.1077
    1.0952
    1.0835
    1.0726
    1.0624
    1.0529
    1.0441
    1.0360
    1.0286
    1.0218
    1.0157
    1.0101
    1.0051
    1.0007
    0.9968
    0.9934
    0.9905
    0.9881
    0.9861
    0.9845
    0.9833
    0.9826
    0.9822
    0.9821
    0.9823
    0.9829
    0.9836
    0.9847
    0.9860
    0.9875
    0.9893
    0.9912
    0.9933
    0.9956
    0.9980
    1.0006
    1.0032
    1.0060
    1.0089
    1.0118
    1.0149
    1.0179
    1.0211
    1.0243
    1.0275
    1.0307
    1.0340
    1.0373
    1.0406
    1.0439
    1.0472
    1.0505
    1.0537
    1.0570
    1.0602
    1.0634
    1.0666
    1.0697
    1.0728
    1.0758
    1.0789
    1.0818
    1.0848
    1.0877
    1.0905
    1.0933
    1.0961
    1.0988
    1.1014
    1.1040
    1.1066
    1.1091
    1.1116
    1.1139
    1.1163
    1.1186
    1.1209
    1.1231
    1.1253
    1.1274
    1.1295
    1.1315
    1.1335
    1.1355
    1.1374
    1.1392
    1.1411
    1.1428
    1.1446
    1.1463
    1.1479
    1.1496
    1.1512
    1.1527
    1.1542
    1.1557
    1.1571
    1.1586
    1.1600
    1.1613
    1.1627
    1.1641
    1.1653
    1.1665
    1.1676
    1.1690
    1.1701
    1.1713
    1.1724
    1.1735
    1.1746
    1.1756
    1.1767
    1.1777
    1.1787
    1.1797
    1.1807
    1.1816
    1.1825
    1.1834
    1.1844
    1.1852
    1.1861
    1.1870
    1.1878
    1.1886
    1.1894
    1.1902
    1.1910
    1.1918
    1.1927
    1.1933
    1.1942
    1.1948
    1.1956
    1.1963
    1.1970
    1.1977
    1.1984
    1.1991
    1.1998
    1.2005
    1.2013
    1.2018
    1.2024
    1.2031
    1.2038
    1.2045
    1.2052
    1.2057
    1.2064
    1.2070
    1.2077
    1.2084
    1.2091
    1.2096
    1.2102
    1.2108
    1.2115
    1.2123
    1.2128
    1.2135
    1.2142
    1.2148
    1.2154
    1.2163
    1.2170
    1.2177
    1.2183
    1.2191
    1.2199
    1.2206
    1.2214
    1.2223
    1.2230
    1.2239
    1.2248
    1.2259
    1.2267
    1.2277
    1.2286
    1.2297
    1.2309
    1.2321
    1.2334
    1.2349
    1.2360
    1.2377
    1.2395
    1.2415
    1.2434
    1.2456
    1.2481
    1.2511
    1.2543
    1.2581
    1.2622
    1.2675
    1.2737
    1.2816
    1.2913
    1.3049
    1.3237
    1.3518
    1.4011
    ];

A_spar_norm = 1000*[
    8.9990
    8.9993
    8.9996
    9.0001
    9.0009
    9.0019
    9.0031
    9.0046
    9.0065
    9.0090
    9.0119
    9.0153
    9.0194
    9.0239
    9.0287
    9.0338
    9.0389
    9.0440
    9.0486
    9.0526
    9.0559
    9.0578
    9.0587
    9.0577
    9.0552
    9.0512
    9.0454
    9.0380
    9.0292
    9.0197
    9.0085
    8.9962
    8.9841
    8.9714
    8.9593
    8.9462
    8.9338
    8.9231
    8.9116
    8.9014
    8.8931
    8.8836
    8.8759
    8.8703
    8.8647
    8.8600
    8.8570
    8.8539
    8.8524
    8.8508
    8.8495
    8.8506
    8.8506
    8.8517
    8.8532
    8.8545
    8.8563
    8.8576
    8.8603
    8.8622
    8.8642
    8.8665
    8.8675
    8.8694
    8.8719
    8.8738
    8.8754
    8.8766
    8.8805
    8.8792
    8.8815
    8.8836
    8.8853
    8.8858
    8.8866
    8.8886
    8.8888
    8.8905
    8.8935
    8.8913
    8.8955
    8.8962
    8.8944
    8.8968
    8.8967
    8.8978
    8.9012
    8.8985
    8.9000
    8.8997
    8.9028
    8.9000
    8.9033
    8.9057
    8.9047
    8.9063
    8.9059
    8.9038
    8.9045
    8.9062
    8.9041
    8.9076
    8.9069
    8.9061
    8.9083
    8.9091
    8.9079
    8.9108
    8.9091
    8.9111
    8.9121
    8.9126
    8.9076
    8.9092
    8.9117
    8.9143
    8.9103
    8.9113
    8.9117
    8.9148
    8.9160
    8.9139
    8.9107
    8.9125
    8.9132
    8.9129
    8.9140
    8.9173
    8.9151
    8.9131
    8.9153
    8.9111
    8.9160
    8.9140
    8.9092
    8.9199
    8.9217
    8.9194
    8.9187
    8.9172
    8.9195
    8.9201
    8.9157
    8.9232
    8.9187
    8.9177
    8.9179
    8.9216
    8.9220
    8.9114
    8.9269
    8.9164
    8.9208
    8.9212
    8.9234
    8.9176
    8.9158
    8.9207
    8.9200
    8.9175
    8.9212
    8.9263
    8.9144
    8.9197
    8.9268
    8.9179
    8.9203
    8.9304
    8.9184
    8.9289
    8.9305
    8.9193
    8.9205
    8.9261
    8.9130
    8.9214
    8.9156
    8.9153
    8.9197
    8.9193
    8.9204
    8.9224
    8.9177
    8.9188
    8.9282
    8.9294
    8.9238
    8.9195
    8.9241
    8.9224
    8.9316
    8.9244
    8.9209
    8.9309
    8.9266
    8.9275
    8.9231
    8.9264
    8.9269
    8.9169
    8.9129
    8.9261
    8.9265
    8.9179
    8.9303
    8.9276
    8.9243
    8.9318
    8.9403
    8.9367
    8.9421
    8.9318
    8.9277
    8.9278
    8.9209
    8.9412
    8.9297
    8.9284
    8.9240
    8.9105
    8.9437
    8.9349
    8.9355
    8.9400
    8.9083
    8.9190
    8.9176
    8.9221
    8.9209
    8.9259
    8.9315
    8.9280
    8.9174
    8.9062
    8.9352
    8.9574
    8.9317
    8.9217
    8.9225
    8.9076
    8.9413
    8.9543
    8.9346
    8.9272
    8.9451
    8.9331
    8.9135
    8.9364
    8.9489
    8.9395
    8.9286
    8.9409
    8.9449
    8.9307
    8.9355
    8.9379
    8.9450
    8.9378
    8.9308
    8.9364
    ];

B_float_norm = [
    1.6609
    6.6301
    14.8658
    26.3020
    40.8410
    58.3553
    78.6911
    101.6692
    127.0809
    154.6936
    184.2535
    215.4844
    248.0947
    281.7777
    316.2130
    351.0767
    386.0333
    420.7487
    454.9019
    488.1730
    520.2593
    550.8907
    579.8189
    606.8317
    631.7446
    654.4266
    674.7751
    692.7511
    708.3290
    721.5380
    732.4241
    741.0729
    747.5970
    752.0956
    754.7135
    755.5699
    754.8035
    752.5565
    748.9413
    744.0884
    738.1227
    731.1364
    723.2296
    714.5007
    705.0137
    694.8699
    684.1073
    672.8168
    661.0468
    648.8324
    636.2397
    623.3332
    610.1156
    596.6646
    582.9961
    569.1559
    555.1849
    541.1008
    526.9600
    512.7655
    498.5789
    484.4071
    470.2824
    456.2327
    442.2785
    428.4390
    414.7384
    401.1976
    387.8400
    374.6628
    361.7080
    348.9461
    336.4240
    324.1608
    312.1945
    300.4102
    288.9587
    277.7519
    266.7960
    256.1614
    245.8174
    235.7320
    225.9946
    216.4672
    207.2456
    198.3642
    189.7330
    181.3967
    173.3478
    165.5648
    158.0647
    150.8359
    143.8710
    137.1651
    130.7154
    124.5231
    118.5620
    112.8522
    107.3698
    102.1116
    97.0766
    92.2555
    87.6426
    83.2326
    79.0150
    74.9835
    71.1360
    67.4630
    63.9596
    60.6220
    57.4362
    54.4057
    51.5181
    48.7698
    46.1573
    43.6724
    41.3095
    39.0660
    36.9340
    34.9113
    32.9908
    31.1702
    29.4415
    27.8031
    26.2499
    24.7798
    23.3867
    22.0686
    20.8211
    19.6390
    18.5229
    17.4668
    16.4674
    15.5236
    14.6314
    13.7900
    12.9927
    12.2424
    11.5320
    10.8629
    10.2319
    9.6372
    9.0756
    8.5457
    8.0465
    7.5759
    7.1319
    6.7150
    6.3213
    5.9504
    5.6019
    5.2736
    4.9643
    4.6732
    4.3991
    4.1412
    3.8987
    3.6718
    3.4571
    3.2549
    3.0665
    2.8878
    2.7202
    2.5629
    2.4156
    2.2754
    2.1454
    2.0222
    1.9070
    1.7989
    1.6976
    1.6013
    1.5113
    1.4265
    1.3481
    1.2735
    1.2036
    1.1379
    1.0763
    1.0185
    0.9644
    0.9133
    0.8648
    0.8202
    0.7773
    0.7381
    0.7010
    0.6656
    0.6328
    0.6019
    0.5723
    0.5448
    0.5196
    0.4953
    0.4726
    0.4510
    0.4304
    0.4125
    0.3940
    0.3778
    0.3621
    0.3471
    0.3330
    0.3205
    0.3075
    0.2962
    0.2851
    0.2752
    0.2651
    0.2561
    0.2479
    0.2394
    0.2316
    0.2247
    0.2179
    0.2115
    0.2053
    0.1996
    0.1945
    0.1892
    0.1844
    0.1796
    0.1754
    0.1717
    0.1672
    0.1637
    0.1612
    0.1575
    0.1542
    0.1514
    0.1487
    0.1458
    0.1433
    0.1409
    0.1382
    0.1357
    0.1335
    0.1309
    0.1286
    0.1260
    0.1237
    0.1211
    0.1180
    0.1154
    0.1120
    0.1083
    0.1043
    0.0995
    0.0943
    0.0872
    0.0805
    0.0701
    0.0589
    0.0433
    0.0228
    -0.0049
    -0.0458
    -0.1053
    -0.2073
    -0.3947
    ];

B_spar_norm = [
    0.0149
    0.0599
    0.1128
    0.1637
    0.1807
    0.1610
    0.1080
    0.0383
    0.0010
    0.0774
    0.4014
    1.0203
    2.1725
    4.0089
    6.6316
    10.2287
    14.9102
    20.8328
    27.9063
    36.0813
    45.4289
    55.7318
    66.7377
    78.1707
    90.0210
    101.6913
    113.0432
    123.8451
    133.5829
    142.1175
    149.6677
    155.7828
    160.0920
    163.0675
    164.2281
    164.1673
    162.7357
    159.7849
    155.8503
    150.8975
    144.9538
    138.5773
    131.5585
    124.1968
    116.5862
    108.8832
    101.2086
    93.6352
    86.2777
    79.1732
    72.3963
    65.9826
    59.9460
    54.3248
    49.1031
    44.2999
    39.8852
    35.8566
    32.2029
    28.8917
    25.9069
    23.2259
    20.8200
    18.6674
    16.7528
    15.0420
    13.5216
    12.1687
    10.9705
    9.9005
    8.9538
    8.1106
    7.3615
    6.6939
    6.0993
    5.5696
    5.0953
    4.6724
    4.2920
    3.9476
    3.6414
    3.3634
    3.1094
    2.8821
    2.6732
    2.4836
    2.3102
    2.1504
    2.0045
    1.8701
    1.7476
    1.6326
    1.5276
    1.4304
    1.3395
    1.2552
    1.1768
    1.1029
    1.0351
    0.9715
    0.9117
    0.8563
    0.8045
    0.7554
    0.7098
    0.6669
    0.6268
    0.5893
    0.5540
    0.5206
    0.4898
    0.4607
    0.4329
    0.4072
    0.3832
    0.3605
    0.3387
    0.3190
    0.3001
    0.2825
    0.2660
    0.2500
    0.2353
    0.2214
    0.2083
    0.1964
    0.1848
    0.1740
    0.1639
    0.1543
    0.1453
    0.1366
    0.1291
    0.1215
    0.1144
    0.1080
    0.1019
    0.0961
    0.0905
    0.0854
    0.0805
    0.0763
    0.0718
    0.0678
    0.0641
    0.0605
    0.0572
    0.0541
    0.0511
    0.0485
    0.0458
    0.0434
    0.0410
    0.0387
    0.0372
    0.0350
    0.0332
    0.0317
    0.0300
    0.0284
    0.0272
    0.0260
    0.0245
    0.0235
    0.0222
    0.0212
    0.0203
    0.0196
    0.0185
    0.0177
    0.0170
    0.0162
    0.0155
    0.0149
    0.0143
    0.0138
    0.0132
    0.0127
    0.0123
    0.0120
    0.0113
    0.0112
    0.0107
    0.0103
    0.0100
    0.0097
    0.0095
    0.0091
    0.0088
    0.0086
    0.0085
    0.0082
    0.0080
    0.0078
    0.0077
    0.0076
    0.0074
    0.0072
    0.0071
    0.0070
    0.0067
    0.0067
    0.0068
    0.0066
    0.0065
    0.0063
    0.0063
    0.0061
    0.0063
    0.0060
    0.0060
    0.0060
    0.0059
    0.0060
    0.0060
    0.0060
    0.0057
    0.0058
    0.0057
    0.0059
    0.0057
    0.0057
    0.0057
    0.0057
    0.0057
    0.0058
    0.0058
    0.0058
    0.0059
    0.0058
    0.0057
    0.0059
    0.0058
    0.0058
    0.0059
    0.0060
    0.0059
    0.0061
    0.0060
    0.0059
    0.0060
    0.0060
    0.0061
    0.0060
    0.0061
    0.0058
    0.0059
    0.0058
    0.0056
    0.0053
    0.0051
    0.0047
    0.0045
    0.0037
    0.0027
    0.0015
    -0.0005
    -0.0035
    -0.0087
    -0.0181
    ];

M1 = 725834;
M2 = 886691;
%M1 = 4.7979e6;
%M2 = 2.1918e7;
K1 = 286*1000*9.8;
K2 = 28*1000*9.8;

Kpto_stablelimit = -K1*K2/(K1 + K2);

[~,ix] = min(abs(T_ref-T));

w = 2*pi/T(ix);
A1 = A_float_norm(ix)*1000;
A2 = A_spar_norm(ix)*1000;
B1 = B_float_norm(ix)*1000*w;
B2 = B_spar_norm(ix)*1000*w;

Z1 = 1i*w*(M1+A1) + 1/(1i*w)*K1 + B1;
Z2 = 1i*w*(M2+A2) + 1/(1i*w)*K2 + B2;

Zt = Z1*Z2/(Z1+Z2);

switch option
    case "damping"
        pto_damping = abs(Zt);
        pto_stiffness = 0;
    case "PI"
        pto_damping = real(Zt);
        pto_stiffness = w*imag(Zt);
        if pto_stiffness < Kpto_stablelimit
            pto_stiffness = 0.9*Kpto_stablelimit;
            pto_damping = sqrt((imag(Zt) - 1/w*pto_stiffness)^2 + real(Zt)^2);
        end
    otherwise
        error("Unknown function option")
end